<ipfixConfig xmlns="urn:ietf:params:xml:ns:ipfix-config">
<!--
  build the following config:
 
  Observer[1] -> Queue[2]  -> Filter[2] -> Aggregator[6]   ->IpfixExporter[7]
                         \
                          \-> Filter[4] -> PSAMPExporter[5]
 
-->

    <!--
     * Create an Observer and capture all IP packets from eth1	
     * and forward them to module 2
    -->
    <observer id="10">
	<interface>eth1</interface>
	<pcap_filter>ip</pcap_filter>
	<next>20</next>
    </observer>

    <!--
     * Create a Queue which could hold 1000 packets
    -->
    <packetQueue id="20">
        <maxSize>1000</maxSize>
        <next>30</next>
        <next>40</next>
    </packetQueue>

    <!--
     * Use a simple count based filter and select 
     * 20% of all the incoming packages 
    -->
    <filter id="30">
        <countBased>
            <interval>20</interval>
            <spacing>80</spacing>
        </countBased>
	<next>60</next>
    </filter>

    <!--
     * Use a count based filter and select 
     * 1% of all the incoming packages 
    -->
    <filter id="40">
        <countBased>
            <interval>1</interval>
            <spacing>99</spacing>
        </countBased>
	<next>50</next>
    </filter>

    <!--
     * export the packets via UDP to 127.0.0.1:1500.
    -->
    <psampExporter id="50">
        <packetReporting>
            <templateId>888</templateId>
            <reportedIE>
                <ieName>sourceIPv4Address</ieName>
            </reportedIE>
            <reportedIE>
                <ieName>destinationIPv4Address</ieName>
            </reportedIE>
            <reportedIE>
                <ieId>313</ieId>
                <ieLength>0</ieLength>
           </reportedIE>
            <reportedIE>
                <ieName>flowStartSeconds</ieName>
            </reportedIE>
        </packetReporting>

	<ipfixPacketRestrictions>
	    <maxPacketSize>1500</maxPacketSize>
	    <maxExportDelay unit="msec">500</maxExportDelay>
	</ipfixPacketRestrictions>
	<udpTemplateManagement>
	    <templateRefreshTimeout>10</templateRefreshTimeout>
	    <templateRefreshRate>100</templateRefreshRate>
	</udpTemplateManagement>
	<collector>
	    <ipAddressType>4</ipAddressType>
	    <ipAddress>127.0.0.1</ipAddress>
	    <transportProtocol>17</transportProtocol>
	    <port>1500</port>
	</collector>
    </psampExporter>

    <!--
     * Aggregate the packets to flows and include the following
     * information:
     *        - source IP and port
     *        - destination IP and port
     *        - protocol type
     *        - flow start time
     *        - octed delta count
     *        - packet delte count
     *
     * Transmit the flows every 5 seconds on an inactive flow or
     * at least every 10 seconds if the flow is still active.
    -->
    <packetAggregator id="60">
    <rule>
	<templateId>998</templateId>
	<flowKey>
	    <ieName>sourceIPv4Address</ieName>
	    <modifier>mask/16</modifier>
	</flowKey>
	<flowKey>
	    <ieName>destinationIPv4Address</ieName>
	</flowKey>
	<flowKey>
	    <ieName>protocolIdentifier</ieName>
	</flowKey>
	<flowKey>
	    <ieName>sourceTransportPort</ieName>
	</flowKey>
	<flowKey>
	    <ieName>destinationTransportPort</ieName>
	</flowKey>
	<nonFlowKey>
	    <ieName>flowStartSeconds</ieName>
	</nonFlowKey>
	<nonFlowKey>
	    <ieName>flowEndSeconds</ieName>
	</nonFlowKey>
	<nonFlowKey>
	    <ieName>octetDeltaCount</ieName>
	</nonFlowKey>
	<nonFlowKey>
	    <ieName>packetDeltaCount</ieName>
	</nonFlowKey>
    </rule>
    <expiration>
	<inactiveTimeout unit="sec">5</inactiveTimeout>
	<activeTimeout unit="sec">10</activeTimeout>
    </expiration>
    <next>70</next>
    </packetAggregator>

    <!--
    Export the flows to 127.0.0.1:1500 via UDP
    -->
    <ipfixExporter id="70">
	<ipfixPacketRestrictions>
	    <maxPacketSize>1500</maxPacketSize>
	    <maxExportDelay unit="msec">500</maxExportDelay>
	</ipfixPacketRestrictions>
	<udpTemplateManagement>
	    <templateRefreshTimeout>10</templateRefreshTimeout>
	    <templateRefreshRate>100</templateRefreshRate>
	</udpTemplateManagement>
	<collector>
	    <ipAddressType>4</ipAddressType>
	    <ipAddress>127.0.0.1</ipAddress>
	    <transportProtocol>17</transportProtocol>
	    <port>1500</port>
	</collector>
    </ipfixExporter>

</ipfixConfig>
